var driveHandler=new function(){var e,t,o={tele:{user:{angle:0,throttle:0},pilot:{angle:0,throttle:0}},brakeOn:!0,recording:!1,driveMode:"user",pilot:"None",session:"None",lag:0,controlMode:"joystick",maxThrottle:1,throttleMode:"user"},a={},n=!1,r=!1,l=!1;this.load=function(){t=new WebSocket("ws://"+location.host+"/wsDrive"),s(),a={zone:document.getElementById("joystick_container"),color:"#668AED",size:350},nipplejs.create(a).on("start",function(e,t){o.tele.user.angle=0,o.tele.user.throttle=0,o.recording=!0,n=!0,m()}).on("end",function(e,t){n=!1,_()}).on("move",function(e,t){o.brakeOn=!1,radian=t.angle.radian,distance=t.distance,o.tele.user.angle=Math.max(Math.min(Math.cos(radian)/70*distance,1),-1),o.tele.user.throttle=j(Math.max(Math.min(Math.sin(radian)/70*distance,1),-1)),o.tele.user.throttle<.001&&(o.tele.user.angle=0)}),navigator.getGamepads&&(console.log("Device has gamepad support."),r=!0),window.DeviceOrientationEvent?(window.addEventListener("deviceorientation",b),console.log("Browser supports device orientation, setting control mode to tilt."),o.controlMode="tilt",function e(){setTimeout(function(){o.brakeOn||h(),"tilt"==o.controlMode&&e()},100)}()):(console.log("Device Orientation not supported by browser, setting control mode to joystick."),o.controlMode="joystick")};var i=function(e,t){let o=!1;return"object"==typeof t&&Object.keys(t).forEach(a=>{e.hasOwnProperty(a)&&e[a]!==t[a]&&("object"==typeof e[a]?o=i(e[a],t[a])&&o:(e[a]=t[a],o=!0))}),o},s=function(){t.onmessage=function(e){console.log(e.data);const t=JSON.parse(e.data);i(o,t)&&c()},$(document).keydown(function(e){32==e.which&&y(),82==e.which&&x(),73==e.which&&M(),75==e.which&&v(),74==e.which&&f(),76==e.which&&w(),65==e.which&&p("local"),85==e.which&&p("user"),83==e.which&&p("local_angle"),77==e.which&&k()}),$("#mode_select").on("change",function(){p($(this).val())}),$("#max_throttle_select").on("change",function(){o.maxThrottle=parseFloat($(this).val())}),$("#throttle_mode_select").on("change",function(){o.throttleMode=$(this).val()}),$("#record_button").click(function(){x()}),$("#brake_button").click(function(){y()}),$("input[type=radio][name=controlMode]").change(function(){"joystick"==this.value?(o.controlMode="joystick",n=!0,console.log("joystick mode"),m()):"tilt"==this.value&&l?(n=!1,o.controlMode="tilt",console.log("tilt mode")):"gamepad"==this.value&&r&&(n=!1,o.controlMode="gamepad",console.log("gamepad mode"),g()),c()})},c=function(){$("#throttleInput").val(o.tele.user.throttle),$("#angleInput").val(o.tele.user.angle),$("#mode_select").val(o.driveMode);var e=Math.round(100*Math.abs(o.tele.user.throttle))+"%",t=Math.round(100*Math.abs(o.tele.user.angle))+"%",a=o.tele.user.throttle.toFixed(2),n=o.tele.user.angle.toFixed(2);$("#throttle_label").html(a),$("#steering_label").html(n),o.tele.user.throttle<0?($("#throttle-bar-backward").css("width",e).html(a),$("#throttle-bar-forward").css("width","0%").html("")):o.tele.user.throttle>0?($("#throttle-bar-backward").css("width","0%").html(""),$("#throttle-bar-forward").css("width",e).html(a)):($("#throttle-bar-forward").css("width","0%").html(""),$("#throttle-bar-backward").css("width","0%").html("")),o.tele.user.angle<0?($("#angle-bar-backward").css("width",t).html(n),$("#angle-bar-forward").css("width","0%").html("")):o.tele.user.angle>0?($("#angle-bar-backward").css("width","0%").html(""),$("#angle-bar-forward").css("width",t).html(n)):($("#angle-bar-forward").css("width","0%").html(""),$("#angle-bar-backward").css("width","0%").html("")),o.recording?$("#record_button").html("Stop Recording (r)").removeClass("btn-info").addClass("btn-warning").end():$("#record_button").html("Start Recording (r)").removeClass("btn-warning").addClass("btn-info").end(),o.brakeOn?$("#brake_button").html("Start Vehicle").removeClass("btn-danger").addClass("btn-success").end():$("#brake_button").html("Stop Vehicle").removeClass("btn-success").addClass("btn-danger").end(),l?($("#tilt-toggle").removeAttr("disabled"),$("#tilt").removeAttr("disabled")):($("#tilt-toggle").attr("disabled","disabled"),$("#tilt").prop("disabled",!0)),r?($("#gamepad-toggle").removeAttr("disabled"),$("#gamepad").removeAttr("disabled")):($("#gamepad-toggle").attr("disabled","disabled"),$("#gamepad").prop("disabled",!0)),"joystick"==o.controlMode?($("#joystick-column").show(),$("#tilt-toggle").removeClass("active"),$("#joystick-toggle").addClass("active"),$("#joystick").attr("checked","checked"),$("#tilt").removeAttr("checked")):"tilt"==o.controlMode&&($("#joystick-column").hide(),$("#joystick-toggle").removeClass("active"),$("#tilt-toggle").addClass("active"),$("#joystick").removeAttr("checked"),$("#tilt").attr("checked","checked"))};const d=["angle","throttle","drive_mode","recording"];var h=function(e=[]){0===e.length&&(e=d);let a={};e.forEach(e=>{switch(e){case"angle":a.angle=o.tele.user.angle;break;case"throttle":a.throttle=o.tele.user.throttle;break;case"drive_mode":a.drive_mode=o.driveMode;break;case"recording":a.recording=o.recording;break;default:console.log(`Unexpected post field: '${e}'`)}}),a&&(console.log(`Posting ${a}`),t.send(JSON.stringify(a)),c())},u=function(e,t){return percentage=(Math.abs(e)-t)/(1-t),percentage<0&&(percentage=0),percentage*(e>0?1:-1)};function g(){if(setTimeout(g,100),"gamepad"==o.controlMode)for(var e=navigator.getGamepads(),t=0;t<e.length;++t){var a=e[t];if(a&&0!=a.timestamp){var n=u(a.axes[2],.05),r=u(a.axes[1],.15);o.tele.user.angle=n,o.tele.user.throttle=j(-1*r),0==o.tele.user.throttle&&0==o.tele.user.throttle?o.brakeOn=!0:o.brakeOn=!1,0!=o.tele.user.throttle?o.recording=!0:o.recording=!1,h()}}}function m(){setTimeout(function(){h(),n&&"joystick"==o.controlMode&&m()},100)}function b(t){t.alpha;var a=t.beta,n=t.gamma;if(null==a||null==n?(l=!1,o.controlMode="joystick",console.log("Invalid device orientation values, switched to joystick mode.")):(l=!0,console.log("device has valid orientation values")),c(),"tilt"==o.controlMode&&l&&!o.brakeOn){!e&&n&&(e=n);var r=C(n),i=O(a,n);o.tele.user.throttle>.9&&r<=0&&(r=1),o.tele.user.throttle<-.9&&r>=0&&(r=-1),o.tele.user.throttle=j(r),o.tele.user.angle=i}}var M=function(){o.tele.user.throttle=j(Math.min(o.tele.user.throttle+.05,1)),h()},v=function(){o.tele.user.throttle=j(Math.max(o.tele.user.throttle-.05,-1)),h()},f=function(){o.tele.user.angle=Math.max(o.tele.user.angle-.1,-1),h()},w=function(){o.tele.user.angle=Math.min(o.tele.user.angle+.1,1),h()},p=function(e){o.driveMode=e,h(["drive_mode"])},k=function(){switch(o.driveMode){case"user":p("local_angle");break;case"local_angle":p("local");break;default:p("user")}},x=function(){o.recording=!o.recording,h(["recording"])},y=function(){o.brakeOn=!o.brakeOn,e=null,o.brakeOn&&_()},_=function(e){console.log("post drive: "+e),o.tele.user.angle=0,o.tele.user.throttle=0,o.recording=!1,o.driveMode="user",h(),++e<5&&setTimeout(function(){console.log("calling brake:"+e),_(e)},500),o.brakeOn=!0,c()},j=function(e){var t=0;return e>0&&(t=Math.min(o.maxThrottle,e)),e<0&&(t=Math.max(-1*o.maxThrottle,e)),"constant"==o.throttleMode&&(t=o.maxThrottle),t},O=function(t,o){var a,n=0,r=-1*Math.sign(e);return t>90?t=(t-180)*Math.sign(-1*o)*r:t<-90&&(t=(t+180)*Math.sign(-1*o)*r),(a=Math.abs(t)>90?Math.abs(t)<175:Math.abs(t)>5)&&t<-90?n=remap(t,-35,-175,-1,0):a&&t>90?n=remap(t,175,35,0,1):a&&t<0?n=remap(t,-35,-5,-1,0):a&&t>0&&(n=remap(t,5,35,0,1)),n<-1?n=-1:n>1&&(n=1),n*r},C=function(t){var o=0,a=t+90,n=e+90,r=-1*Math.sign(e),l=Math.min(n+5*r,n+50*r),i=Math.max(n+5*r,n+50*r),s=Math.min(n-50*r,n-5*r),c=Math.max(n-50*r,n-5*r);return l=Math.max(l,0),i=Math.min(i,180),s=Math.max(s,0),c=Math.min(c,180),a>l&&a<i?o=-1==r?remap(a,l,i,1,0):remap(a,l,i,0,1):a>s&&a<c&&(o=-1==r?remap(a,s,c,0,-1):remap(a,s,c,-1,0)),o}};function toRadians(e){return e*(Math.PI/180)}function remap(e,t,o,a,n){if(t==o)return console.log("Warning: Zero input range"),None;if(a==n)return console.log("Warning: Zero output range"),None;var r=!1;oldMin=Math.min(t,o),oldMax=Math.max(t,o),oldMin!=t&&(r=!0);var l=!1;newMin=Math.min(a,n),newMax=Math.max(a,n),newMin!=a&&(l=!0);var i=(e-oldMin)*(newMax-newMin)/(oldMax-oldMin);r&&(i=(oldMax-e)*(newMax-newMin)/(oldMax-oldMin));var s=i+newMin;return l&&(s=newMax-i),s}